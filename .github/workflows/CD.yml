name: CD

on:
  # Automatically deploy when the CI workflow completes
  workflow_run:
    workflows: [ "CI" ]
    types: [ "completed" ]

  # Allow manual runs from the Actions tab
  workflow_dispatch:

jobs:
  deploy-to-kubernetes:
    # Only run if CI succeeded, or if manually triggered
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      PROD_HOST: 54.210.218.88
      PROD_USER: ubuntu
      REMOTE_K8S_DIR: /home/ubuntu/ansible/k8s
      KUBECONFIG_PATH: /home/ubuntu/.kube/config

    steps:
      - name: Checkout repository at CI commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$PROD_HOST" >> ~/.ssh/known_hosts

      - name: Copy Kubernetes manifests to production server
        run: |
          scp -o StrictHostKeyChecking=no \
            k8s/deployment.yaml k8s/service.yaml \
            ${PROD_USER}@${PROD_HOST}:${REMOTE_K8S_DIR}/

      - name: Deploy to Kubernetes with rolling update
        run: |
          ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_HOST} << 'EOF'
          set -e
          export KUBECONFIG=/home/ubuntu/.kube/config

          cd /home/ubuntu/ansible/k8s

          # Apply all manifests (deployment + service)
          kubectl apply -f .

          # Try to wait for the rolling update to finish, but don't fail the pipeline if it times out
          set +e
          kubectl rollout status deployment/weather-ml-deployment --timeout=120s
          ROLLOUT_STATUS=$?
          set -e

          if [ "$ROLLOUT_STATUS" -ne 0 ]; then
            echo "WARNING: rollout did not complete successfully, but manifests were applied."
          fi

          # Show pods for logging / evidence
          kubectl get pods -o wide || true
          EOF


